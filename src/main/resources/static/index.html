<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Threat Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<h1 class="mb-4">Threat Dashboard</h1>

<table class="table table-bordered table-striped align-middle">
    <thead class="table-dark">
    <tr>
        <th>IP Address</th>
        <th>Total Events</th>
        <th>Latest At</th>
        <th>Threat Types</th>
        <th>Recommendations</th>
        <th style="width: 1%">Details</th>
    </tr>
    </thead>
    <tbody id="threat-table-body">
    <tr><td colspan="6" class="text-center">Loading...</td></tr>
    </tbody>
</table>

<script>
    function pickLatestSample(samples) {
        // choose the sample with the newest timestamp
        // sample may have "at" or "latestAt" — support both
        return samples.reduce((acc, s) => {
            const t = new Date(s.at || s.latestAt || 0).getTime();
            const accT = new Date(acc.at || acc.latestAt || 0).getTime();
            return t > accT ? s : acc;
        }, samples[0]);
    }

    async function loadThreats() {
        const from = "2025-08-10T12:00:00Z";
        const to   = "2025-08-15T15:00:00Z";
        const url  = `http://localhost:8080/api/dashboard/threats?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();

            const tbody = document.getElementById("threat-table-body");
            tbody.innerHTML = "";

            (data.ips || []).forEach(ipData => {
                const allThreats = new Set();
                const allRecommendations = new Set();

                (ipData.samples || []).forEach(sample => {
                    (sample.threats || []).forEach(t => allThreats.add(t));
                    (sample.recommendations || []).forEach(r => allRecommendations.add(r));
                });

                const latestSample = (ipData.samples && ipData.samples.length)
                    ? pickLatestSample(ipData.samples)
                    : null;

                const latestAt = ipData.latestAt || (latestSample ? latestSample.at : null);

                const detailsBtn = latestSample && latestSample.id
                    ? `<a class="btn btn-sm btn-primary" href="details.html?id=${encodeURIComponent(latestSample.id)}">View</a>`
                    : `<button class="btn btn-sm btn-secondary" disabled>—</button>`;

                const row = `
            <tr>
              <td>${ipData.ip ?? ""}</td>
              <td>${ipData.count ?? 0}</td>
              <td>${latestAt ? new Date(latestAt).toLocaleString() : "—"}</td>
              <td>${Array.from(allThreats).join(", ") || "—"}</td>
              <td>${Array.from(allRecommendations).join(", ") || "—"}</td>
              <td class="text-center">${detailsBtn}</td>
            </tr>
          `;
                tbody.insertAdjacentHTML("beforeend", row);
            });

            if (!data.ips || data.ips.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">No data</td></tr>`;
            }
        } catch (error) {
            document.getElementById("threat-table-body").innerHTML =
                `<tr><td colspan="6" class="text-center text-danger">Error loading data: ${error}</td></tr>`;
        }
    }

    loadThreats();
</script>
</body>
</html>
