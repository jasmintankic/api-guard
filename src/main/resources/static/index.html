<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
    <h1 class="mb-4">Threat Dashboard</h1>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>IP Address</th>
                <th>Total Events</th>
                <th>Latest At</th>
                <th>Threat Types</th>
                <th>Recommendations</th>
            </tr>
        </thead>
        <tbody id="threat-table-body">
            <tr><td colspan="5" class="text-center">Loading...</td></tr>
        </tbody>
    </table>

    <script>
        async function loadThreats() {
            const from = "2025-08-10T12:00:00Z";
            const to = "2025-08-15T15:00:00Z";
            const url = `http://localhost:8080/api/dashboard/threats?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                const data = await response.json();

                const tbody = document.getElementById("threat-table-body");
                tbody.innerHTML = "";

                data.ips.forEach(ipData => {
                    const allThreats = new Set();
                    const allRecommendations = new Set();

                    ipData.samples.forEach(sample => {
                        sample.threats.forEach(t => allThreats.add(t));
                        sample.recommendations.forEach(r => allRecommendations.add(r));
                    });

                    const row = `
                        <tr>
                            <td>${ipData.ip}</td>
                            <td>${ipData.count}</td>
                            <td>${new Date(ipData.latestAt).toLocaleString()}</td>
                            <td>${Array.from(allThreats).join(", ")}</td>
                            <td>${Array.from(allRecommendations).join(", ")}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML("beforeend", row);
                });

            } catch (error) {
                document.getElementById("threat-table-body").innerHTML =
                    `<tr><td colspan="5" class="text-center text-danger">Error loading data: ${error}</td></tr>`;
            }
        }

        loadThreats();
    </script>
</body>
</html>